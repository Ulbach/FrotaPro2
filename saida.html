
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Registrar Saída — Frota Pro</title>
<style>
  :root{ --bg:#f1f5f9; --card:#fff; --muted:#64748b; --text:#0b1020; --accent:#16a34a; --danger:#dc2626; --border:#e2e8f0; --shadow:0 16px 40px rgba(0,0,0,.12) }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  .phone{width:420px;max-width:100%;min-height:90vh;margin:20px auto;background:var(--card);border-radius:22px;box-shadow:var(--shadow);overflow:hidden}
  .wrap{padding:18px}
  .top{display:flex;align-items:center;gap:10px}
  .back{width:36px;height:36px;border-radius:10px;border:1px solid var(--border);display:grid;place-items:center;cursor:pointer;background:#fff}
  h1{margin:0;font-size:20px;color:#0f172a}
  .card{margin-top:14px;border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 6px 14px rgba(2,6,23,.06)}
  .banner-warn{display:none;margin-bottom:8px;padding:10px;border:1px solid var(--danger);color:#7f1d1d;background:#fee2e2;border-radius:10px;font-size:13px;font-weight:700}
  label{display:block;margin:12px 0 6px;font-weight:700}
  select,input{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px;background:#fff}
  .field{margin-bottom:6px}
  .hint-danger{color:var(--danger);font-size:12px;margin-top:6px;display:none}
  .danger{border-color:var(--danger)!important}
  .btn{margin-top:10px;width:100%;padding:12px;border:0;border-radius:12px;background:var(--accent);color:#fff;font-weight:800;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .msg{margin-top:12px;font-weight:700}
  .ok{color:var(--accent)} .err{color:var(--danger)}
  .muted{color:var(--muted);font-size:12px;margin-top:8px}
  .row-inline{display:flex;align-items:center;gap:8px;margin-top:6px}
  .row-inline label{margin:0;font-weight:600}
</style>
</head>
<body>
<div class="phone">
  <div class="wrap">
    <div class="top">
      <div class="back" onclick="history.back()" title="Voltar">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M15 6l-6 6 6 6" stroke="#334155" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      <h1>Registrar Saída</h1>
    </div>

    <div class="card">
      <div id="warnCurso" class="banner-warn">VEÍCULO EM CURSO — conclua a ENTRADA antes de registrar nova SAÍDA.</div>

      <div class="field">
        <label for="veiculo">Veículo</label>
        <select id="veiculo"><option value="">Carregando...</option></select>
        <div class="row-inline">
          <input type="checkbox" id="ckShowBusy" />
          <label for="ckShowBusy">Mostrar veículos em curso (somente leitura)</label>
        </div>
      </div>

      <div class="field">
        <label for="motorista">Motorista</label>
        <select id="motorista"><option value="">Selecione o motorista</option></select>
      </div>

      <div class="field">
        <label for="kmSaida">Km Saída</label>
        <input id="kmSaida" type="number" min="0" step="1" placeholder="Ex.: 15700" />
        <div id="kmAtualHint" class="hint-danger"></div>
      </div>

      <div class="field">
        <label for="destino">Destino (opcional)</label>
        <input id="destino" type="text" placeholder="Ex.: Fazenda X / Filial Y" />
      </div>

      <div class="field">
        <label for="seguranca">Segurança</label>
        <select id="seguranca"><option value="">Selecione o segurança</option></select>
      </div>

      <button id="btnEnviar" class="btn">Gravar Saída</button>

      <div class="muted">
        Listas vêm da aba <b>Listagem2</b>. Data/hora é registrada automaticamente no formato
        <i>dd/MM/yyyy HH:mm:ss</i>.
      </div>
      <div id="msg" class="msg"></div>
    </div>
  </div>
</div>

<script>
  // ===== CONFIG =====
  const API_URL = 'https://script.google.com/macros/s/AKfycbwE8F061OhUN5lTom2nZ0W_Vm5LX2wAWhPE4rtd6umbaxcIdmjaAzEtlf-wOHVpgDl-4g/exec';

  // ===== STATE =====
  let KM_ATUAL = 0;
  let EM_CURSO = false;
  let DISPONIVEIS = [];
  let OCUPADOS = [];

  // ===== HTTP =====
  async function apiGet(route, params = {}){
    const usp = new URLSearchParams({ route, t: Date.now(), ...params });
    const res = await fetch(`${API_URL}?${usp.toString()}`, { method:'GET' });
    if(!res.ok){ const txt=await res.text().catch(()=> ''); throw new Error(`GET ${res.status}: ${txt}`); }
    return res.json();
  }
  async function apiPost(route, data = {}){
    const usp = new URLSearchParams({ route, t: Date.now() });
    const res = await fetch(`${API_URL}?${usp.toString()}`, {
      method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(data||{})
    });
    const txt = await res.text().catch(()=> ''); let json={}; try{ json=JSON.parse(txt);}catch{}
    if(!res.ok || json?.ok===false) throw new Error(json?.error || txt || 'Erro no POST');
    return json;
  }

  // ===== UI HELPERS =====
  function setMsg(text, ok){ const el=document.getElementById('msg'); el.textContent=text||''; el.className='msg '+(ok?'ok':'err'); }
  const fmtKm = n => (Number(n)||0).toLocaleString('pt-BR');

  function fillVeiculosSelect(soDisponiveis=true, preselect=null){
    const sel = document.getElementById('veiculo');
    sel.innerHTML = '';
    const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent = 'Selecione o veículo'; sel.appendChild(opt0);

    DISPONIVEIS.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });

    if(!soDisponiveis){
      const grp = document.createElement('optgroup'); grp.label = 'Em curso (indisponíveis)';
      OCUPADOS.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=`${v} (EM CURSO)`; o.disabled=true; grp.appendChild(o); });
      sel.appendChild(grp);
    }
    if(preselect){
      sel.value = preselect;
      if(sel.value !== preselect){ /* estava em curso e oculto */ document.getElementById('ckShowBusy').checked = true; fillVeiculosSelect(false, preselect); sel.value = preselect; }
      sel.dispatchEvent(new Event('change'));
    }
  }

  function setFormDisabled(disabled){
    ['motorista','kmSaida','destino','seguranca','btnEnviar'].forEach(id=>{
      const el = document.getElementById(id); if(!el) return; el.disabled = disabled;
    });
  }

  // ===== PAGE LOGIC =====
  async function loadLists(){
    try{
      let L;
      try {
        L = await apiGet('listsAvail'); // preferencial
      } catch (e) {
        // fallback p/ compatibilidade
        const base = await apiGet('lists');
        L = { veiculosDisponiveis: base.veiculos||[], veiculosEmCurso: [], motoristas: base.motoristas||[], segurancas: base.segurancas||[] };
      }
      DISPONIVEIS = L.veiculosDisponiveis || [];
      OCUPADOS    = L.veiculosEmCurso     || [];
      const q = new URLSearchParams(location.search);
      const pre = q.get('veiculo');
      fillVeiculosSelect(true, pre);

      // Demais listas
      document.getElementById('motorista').innerHTML = '<option value="">Selecione o motorista</option>' + (L.motoristas||[]).map(v=>`<option value="${v}">${v}</option>`).join('');
      document.getElementById('seguranca').innerHTML = '<option value="">Selecione o segurança</option>' + (L.segurancas||[]).map(v=>`<option value="${v}">${v}</option>`).join('');

      if(!pre) document.getElementById('veiculo').focus();
    }catch(e){
      setMsg('Erro ao carregar listas: '+e.message, false);
    }
  }

  async function onChangeVeiculo(){
    const veiculo = (document.getElementById('veiculo').value||'').trim();
    const warn = document.getElementById('warnCurso');
    const hint = document.getElementById('kmAtualHint');
    const kmI  = document.getElementById('kmSaida');

    EM_CURSO = false; KM_ATUAL = 0;
    warn.style.display='none'; hint.style.display='none';
    kmI.classList.remove('danger'); setFormDisabled(false); setMsg('',true);

    if(!veiculo) return;

    try{
      const st = await apiGet('statusVeiculo', { veiculo });
      EM_CURSO = !!st.emCurso;
      KM_ATUAL = Number(st.kmAtual||0);

      hint.textContent = `Km atual do veículo: ${fmtKm(KM_ATUAL)}`;
      hint.style.display = 'block';

      if(EM_CURSO){
        warn.style.display='block';
        setFormDisabled(true);
        document.getElementById('veiculo').disabled = false;
        document.getElementById('btnEnviar').disabled = true;
      }else{
        validateKm();
      }
    }catch(e){
      hint.textContent = 'Não foi possível obter o status/Km atual.';
      hint.style.display = 'block';
    }
  }

  const validateKm = () => {
    const kmI = document.getElementById('kmSaida');
    const v = Number((kmI.value||'').trim());
    const btn = document.getElementById('btnEnviar');
    if(EM_CURSO){ btn.disabled=true; return false; }
    if(Number.isFinite(v) && v < KM_ATUAL){
      kmI.classList.add('danger');
      setMsg(`O Km Saída (${v.toLocaleString('pt-BR')}) é MENOR que o Km atual (${fmtKm(KM_ATUAL)}). Oriente o Segurança e corrija.`, false);
      btn.disabled = true; return false;
    }
    kmI.classList.remove('danger'); setMsg('',true); btn.disabled=false; return true;
  };

  async function submit(){
    const veiculo   = (document.getElementById('veiculo').value||'').trim();
    const motorista = (document.getElementById('motorista').value||'').trim();
    const seguranca = (document.getElementById('seguranca').value||'').trim();
    const kmSaida   = Number((document.getElementById('kmSaida').value||'').trim());
    const destino   = (document.getElementById('destino').value||'').trim();

    if(EM_CURSO){ setMsg('Veículo NÃO disponível: há uma saída em curso.', false); return; }
    if(!veiculo || !motorista || !seguranca || !Number.isFinite(kmSaida)){ setMsg('Preencha Veículo, Motorista, Segurança e Km Saída.', false); return; }
    if(!validateKm()) return;

    const btn = document.getElementById('btnEnviar'); btn.disabled = true; setMsg('Enviando...', true);
    try{
      const r = await apiPost('saida', { veiculo, motorista, seguranca, kmSaida, destino });
      setMsg(r.message + (r.timestamp ? ` — ${r.timestamp}` : ''), true);
      setTimeout(()=> location.href = './', 1200);
    }catch(e){
      setMsg('Erro: ' + e.message, false);
      btn.disabled = false;
    }
  }

  document.getElementById('btnEnviar').addEventListener('click', submit);
  document.getElementById('veiculo').addEventListener('change', onChangeVeiculo);
  document.getElementById('kmSaida').addEventListener('input', validateKm);
  document.getElementById('ckShowBusy').addEventListener('change', (e)=> fillVeiculosSelect(!e.target.checked));

  window.addEventListener('load', loadLists);
</script>
</body>
</html>
